---
title: "Richmond Shop Performance"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, asis=T, warning = F)
library(dplyr)
library(stringr)
library(openxlsx)
library(ggplot2)
library(tidyr)
library(scales)
library(knitr)
library(lubridate)
library(gridExtra)
library(ggrepel)
library(bcmaps)
library(sf)
library(canadianmaps)
Clover_customer <- read.csv("../Clover/Customers-20251208_0943_PST.csv", as.is = T) %>% mutate(Name = paste0(First.Name, " ", Last.Name)) %>% distinct(Email.Address, .keep_all = T) %>% filter(Name != " ", Email.Address != "") %>% `row.names<-`(.[, "Name"])
JJR_customer <- read.csv("../Clover/Sales2412-2511/wc-customers-report-export-17653189392578.csv", as.is = T) %>% distinct(Email, .keep_all = T) %>% `row.names<-`(.[, "Email"])
Payment <- read.csv("../Clover/Sales2412-2511/CloverSO-202412-202511_excludeWarehouseSale.csv", as.is = T) %>% mutate(Date = as.Date(gsub(" .*", "", Payment.Date), format = "%d-%b-%Y"), Month = format(Date, "%b"), DayOfWeek = format(Date, "%a"), Email = Clover_customer[Customer.Name, "Email.Address"], City = JJR_customer[Email, "City"], Province = JJR_customer[Email, "Region"], Postal.Code = JJR_customer[Email, "Postal.Code"]) %>% filter(Result == "SUCCESS", Amount != 0, Order.Employee.Name != "Garman") %>% select(Date, Month, DayOfWeek, Tender, Amount, Tax.Amount, Customer.Name, Email, City, Province, Postal.Code, Payment.ID, Order.ID)
Payment_daily <- Payment %>% group_by(Date) %>% summarise(Amount = sum(Amount), N = n())
days <- seq(from = as.Date("2024-12-01"), to = as.Date("2025-11-30"), by = "days")
workdays <- days[wday(days) != 1 & !days %in% c(seq(from = as.Date("2024-12-25"), to = as.Date("2025-01-01"), by = "days"), "2025-02-17", "2025-04-18", "2025-04-21", "2025-05-19", "2025-07-01", "2025-08-04", "2025-09-01", "2025-09-30", "2025-10-13", "2025-11-11", "2025-07-12", seq(from = as.Date("2025-07-16"), to = as.Date("2025-07-19"), by = "days"))]
Payment_daily <- rbind(Payment_daily, data.frame(Date = workdays[!workdays %in% Payment_daily$Date], Amount = 0, N = 0)) %>% arrange(Date)
JJR_payment <- read.csv("../Clover/Sales2412-2511/wc-orders-BC-202412-202511.csv", as.is = T) %>% distinct(Order.Number, .keep_all = T) %>% mutate(Date = as.Date(gsub(" .*", "", Order.Date)))
Refund <- read.csv("../Clover/Sales2412-2511/Refunds-202412-202511.csv", as.is = T) %>% mutate(Date = as.Date(gsub(" .*", "", Refund.Date), format = "%d-%b-%Y"), Month = format(Date, "%b"), DayOfWeek = format(Date, "%a")) %>% select(Date, Month, DayOfWeek, Refund.Amount, Refund.ID)
```

This is report of Richmond shop performance from Dec 01 2024 to Nov 30 2025. Warehouse sales were excluded from the analysis but other sales events such as Back to School and Black Friday were not as they happen every year around the same time.    

## Summary

  * Total Revenue:  __`r dollar(sum(Payment$Amount), accuracy = 0.01)`__ (Website BC at the same time period __`r dollar(sum(JJR_payment$Order.Total.Amount), accuracy = 0.01)`__, __`r percent(sum(Payment$Amount)/sum(JJR_payment$Order.Total.Amount))`__)
  * Total No. of orders:  __`r nrow(Payment)`__ (Website BC at the same time period __`r nrow(JJR_payment)`__, __`r percent(nrow(Payment)/nrow(JJR_payment))`__)
  * Total Refund:  __`r dollar(sum(Refund$Refund.Amount), accuracy = 0.01)`__ 
  * Total No. of refunds:  __`r nrow(Refund)`__ (__`r percent(nrow(Refund)/nrow(Payment))`__)
  * Average daily sales:  __`r dollar(mean(Payment_daily$Amount), accuracy = 0.01)`__
  * Average daily No. of orders:  __`r round(mean(Payment_daily$N))`__
  * Average order size:  __`r dollar(sum(Payment$Amount)/nrow(Payment), accuracy = 0.01)`__ 
  * Top sales occur during Back to School sales  

```{r summary, fig.height=4, fig.width=12}
(trend <- ggplot(Payment, aes(Date, Amount)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("Sales trend 2024-12-01 to 2025-11-30") + 
   theme_bw())
```


### Sales by month
```{r month, fig.height=4, fig.width=12}
Payment_month <- Payment %>% group_by(Month) %>% summarise(Amount = sum(Amount), N = n()) %>% mutate(Average = Amount/N, Month = factor(Month, level = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
Revenue_month <- ggplot(Payment_month, aes(Month, Amount)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("Revenue by Month") + 
   theme_bw()
N_month <- ggplot(Payment_month, aes(Month, N)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("No. of orders by Month") + 
   theme_bw()
Average_month <- ggplot(Payment_month, aes(Month, Average)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("Average order size by Month") + 
   theme_bw()
grid.arrange(Revenue_month, N_month, Average_month, nrow = 1)
```

### Sales by day of week
```{r week, fig.height=4, fig.width=12}
Payment_week <- Payment %>% filter(DayOfWeek != "Sun") %>% group_by(DayOfWeek) %>% summarise(Amount = sum(Amount), N = n()) %>% mutate(Average = Amount/N, DayOfWeek = factor(DayOfWeek, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat")))
Revenue_week <- ggplot(Payment_week, aes(DayOfWeek, Amount)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("Revenue by day of week") + 
   theme_bw()
N_week <- ggplot(Payment_week, aes(DayOfWeek, N)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("No. of orders by day of week") + 
   theme_bw()
Average_week <- ggplot(Payment_week, aes(DayOfWeek, Average)) + 
   geom_bar(stat = "identity", position = "stack", width = 0.8) + 
   ggtitle("Average order size by day of week") + 
   theme_bw()
grid.arrange(Revenue_week, N_week, Average_week, nrow = 1)
```

### Customer regional analysis

```{r customer}
Customer_Clover_N <- Payment %>% group_by(Email) %>% summarise(N = n()) %>% filter(!is.na(Email))
```

  * No. of recorded customers 2024.12-2025.11: __`r nrow(Customer_Clover_N)`__
  * No. of repeat customers: __`r nrow(Customer_Clover_N %>% filter(N > 1))`__ (__`r percent(nrow(Customer_Clover_N %>% filter(N > 1))/nrow(Customer_Clover_N))`__)
  * Estimated No. of new customers from the shop (not previously shopped on JJ website, but did not exclude those previously shopped on Amazon): __`r nrow(Customer_Clover_N %>% filter(!(Email %in% JJR_customer$Email)))`__ (__`r percent(nrow(Customer_Clover_N %>% filter(!(Email %in% JJR_customer$Email)))/nrow(Customer_Clover_N))`__) 

```{r map}
Clover_map <- Payment %>% mutate(fsa_code = toupper(strtrim(Postal.Code, 3))) %>% group_by(fsa_code) %>% summarise(order_count = n(), Amount = sum(Amount)) %>% ungroup()
JJR_map <- JJR_payment %>% mutate(fsa_code = toupper(strtrim(Postcode..Shipping., 3))) %>% group_by(fsa_code) %>% summarise(order_count = n(), Amount = sum(Order.Total.Amount)) %>% ungroup()
# get map data specifically for the Greater Vancouver Regional District
bc_regional_districts <- regional_districts()
cities_bc <- bcmaps::bc_cities()
gva_boundary <- bc_regional_districts %>% filter(grepl("Vancouver", ADMIN_AREA_NAME)) # the Greater Vancouver area
cities_in_gva <- st_intersection(cities_bc, st_union(gva_boundary)) %>% filter(LONG_TYPE == "CITY")
gva_municipalities <- municipalities()
gva_municipalities_filtered <- st_intersection(gva_municipalities, st_union(gva_boundary))
data(FSA)
bc_fsa_map_data <- st_transform(FSA %>% filter(PT == "BC"), st_crs(gva_boundary))
fsa_in_gva <- st_intersection(bc_fsa_map_data, st_union(gva_boundary))
Clover_gva_map_data_final <- left_join(fsa_in_gva, Clover_map, by = c("CFSAUID" = "fsa_code")) %>%
  mutate(order_count = replace_na(order_count, 0), Amount = replace_na(Amount, 0))
(Clover_map_plot <- ggplot(data = Clover_gva_map_data_final) +
  geom_sf(aes(fill = order_count), color = "white", linewidth = 0.2) +
  # Add the city outlines layer ON TOP of the FSA colors
  geom_sf(data = gva_municipalities_filtered, fill = NA, color = "darkgrey", linewidth = 0.8) +
  # Add the city labels layer
  ggrepel::geom_label_repel(data = cities_in_gva, aes(label = as.character(NAME), geometry = geometry),
    stat = "sf_coordinates", # Tells ggrepel to use the sf coordinates
    min.segment.length = 0, box.padding = 0.5, point.padding = 0.5, size = 3.5, color = "black", fontface = "bold") +
  # Ensure points for cities are visible
  geom_sf(data = cities_in_gva, color = "red", size = 2) +
  scale_fill_viridis_c(option = "plasma", name = "# Orders", direction = -1, limits = c(0, max(Clover_gva_map_data_final$order_count))) +
  labs(title = "Richmond Shop Customers", x = NULL, y = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.text = element_text(size = 8), legend.title = element_text(size = 10), legend.key.size = unit(0.5, "cm")))
JJR_gva_map_data_final <- left_join(fsa_in_gva, JJR_map, by = c("CFSAUID" = "fsa_code")) %>%
  mutate(order_count = replace_na(order_count, 0), Amount = replace_na(Amount, 0))
(JJR_map_plot <- ggplot(data = JJR_gva_map_data_final) +
  geom_sf(aes(fill = order_count), color = "white", linewidth = 0.2) +
  # Add the city outlines layer ON TOP of the FSA colors
  geom_sf(data = gva_municipalities_filtered, fill = NA, color = "darkgrey", linewidth = 0.8) +
  # Add the city labels layer
  ggrepel::geom_label_repel(data = cities_in_gva, aes(label = as.character(NAME), geometry = geometry),
    stat = "sf_coordinates", # Tells ggrepel to use the sf coordinates
    min.segment.length = 0, box.padding = 0.5, point.padding = 0.5, size = 3.5, color = "black", fontface = "bold") +
  # Ensure points for cities are visible
  geom_sf(data = cities_in_gva, color = "red", size = 2) +
  scale_fill_viridis_c(option = "plasma", name = "# Orders", direction = -1, limits = c(0, max(JJR_gva_map_data_final$order_count))) +
  labs(title = "Website Customers", x = NULL, y = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.text = element_text(size = 8), legend.title = element_text(size = 10), legend.key.size = unit(0.5, "cm")))
Population_map <- read.csv("../Clover/Sales2412-2511/Population_census2021.csv", as.is = T) %>% mutate(Occupied.Dwellings = as.numeric(gsub(",", "", Occupied.Dwellings)))
Population_gva_map_data_final <- left_join(fsa_in_gva, Population_map, by = c("CFSAUID" = "FSA")) %>%
  mutate(Occupied.Dwellings = replace_na(Occupied.Dwellings, 0))
(Population_map_plot <- ggplot(data = Population_gva_map_data_final) +
  geom_sf(aes(fill = Occupied.Dwellings), color = "white", linewidth = 0.2) +
  # Add the city outlines layer ON TOP of the FSA colors
  geom_sf(data = gva_municipalities_filtered, fill = NA, color = "darkgrey", linewidth = 0.8) +
  # Add the city labels layer
  ggrepel::geom_label_repel(data = cities_in_gva, aes(label = as.character(NAME), geometry = geometry),
    stat = "sf_coordinates", # Tells ggrepel to use the sf coordinates
    min.segment.length = 0, box.padding = 0.5, point.padding = 0.5, size = 3.5, color = "black", fontface = "bold") +
  # Ensure points for cities are visible
  geom_sf(data = cities_in_gva, color = "red", size = 2) +
  scale_fill_viridis_c(option = "plasma", name = "# Dwellings", direction = -1, limits = c(0, max(Population_gva_map_data_final$Occupied.Dwellings))) +
  labs(title = "Occupied Dwellings", x = NULL, y = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.text = element_text(size = 8), legend.title = element_text(size = 10), legend.key.size = unit(0.5, "cm")))
childcares <- read.csv("../Clover/Sales2412-2511/childcare_locations.csv", as.is = T) %>% mutate(FSA = toupper(strtrim(POSTAL_CODE, 3))) %>% group_by(FSA) %>% summarise(Childcares = n()) %>% ungroup()
Childcares_gva_map_data_final <- left_join(fsa_in_gva, childcares, by = c("CFSAUID" = "FSA")) %>%
  mutate(Childcares = replace_na(Childcares, 0))
(Childcares_map_plot <- ggplot(data = Childcares_gva_map_data_final) +
  geom_sf(aes(fill = Childcares), color = "white", linewidth = 0.2) +
  # Add the city outlines layer ON TOP of the FSA colors
  geom_sf(data = gva_municipalities_filtered, fill = NA, color = "darkgrey", linewidth = 0.8) +
  # Add the city labels layer
  ggrepel::geom_label_repel(data = cities_in_gva, aes(label = as.character(NAME), geometry = geometry),
    stat = "sf_coordinates", # Tells ggrepel to use the sf coordinates
    min.segment.length = 0, box.padding = 0.5, point.padding = 0.5, size = 3.5, color = "black", fontface = "bold") +
  # Ensure points for cities are visible
  geom_sf(data = cities_in_gva, color = "red", size = 2) +
  scale_fill_viridis_c(option = "plasma", name = "# Childcares", direction = -1, limits = c(0, max(Childcares_gva_map_data_final$Childcares))) +
  labs(title = "Childcares", x = NULL, y = NULL) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.text = element_text(size = 8), legend.title = element_text(size = 10), legend.key.size = unit(0.5, "cm")))
```

### Sales by category

  * The top 5 best selling categories by quantity overall are: WJA, BTL, WPF, BRC, BTB
  * Top categories in each month are different

```{r category}
Category <- read.csv("../Clover/Sales2412-2511/LineItemsExport-202412-202511.csv", as.is = T)%>% mutate(Month = format(as.Date(gsub(" .*", "", Line.Item.Date), format = "%d-%b-%Y"), "%b"), Category = gsub("-.*", "", Item.Name)) %>% filter(Order.ID %in% Payment$Order.ID, !grepl("MISC", Category)) %>% group_by(Category, Month) %>% summarise(Qty = n()) %>% arrange(Month, desc(Qty))
(Category_alltime <- ggplot(Category %>% group_by(Category) %>% summarise(Qty = sum(Qty)), aes(reorder(Category, Qty), Qty)) + 
    geom_bar(position = "identity", stat = "identity", width = 0.8) + 
    coord_flip(xlim = c(length(unique(Category$Category))-9, length(unique(Category$Category)))) + 
    xlab("") + ylab("") + 
    ggtitle("Top 10 best selling categories 2024-12-01 to 2025-11-30") +
    theme_bw())
Category_month <- list()
months <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
for(i in 1:12){
  Category_m <- ggplot(Category %>% filter(Month == months[i]), aes(reorder(Category, Qty), Qty)) + 
    geom_bar(position = "identity", stat = "identity", width = 0.8) + 
    coord_flip(xlim = c(length(unique((Category %>% filter(Month == months[i]))$Category))-4, length(unique((Category %>% filter(Month == months[i]))$Category)))) + 
    xlab("") + ylab("") + 
    ggtitle(months[i]) +
    theme_bw()
  Category_month[[i]] <- Category_m
}
grid.arrange(grobs = Category_month, ncol = 4)
```


